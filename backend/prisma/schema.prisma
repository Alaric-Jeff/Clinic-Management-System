// This is your Prisma schema file
// Learn more at: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------- ENUMS ----------------

// Roles for staff accounts
enum Role {
  admin
  encoder
}

// Categories for lab services
enum ServiceCategory {
  hematology
  bacteriology
  clinical_microscopy
  twenty_four_hour_urine_test
  serology_immunology
  clinical_chemistry
  electrolytes
  vaccine
  histopathology
  to_be_read_by_pathologist
  tumor_markers
  thyroid_function_test
  hormones
  hepatitis
  enzymes
  others
}

// Status for accounts
enum AccountStatus {
  activated
  deactivated
  pending
}

// Status for medical documentation progress
enum DocumentationStatus {
  complete
  incomplete
  draft
}

// ---------------- MODELS ----------------

model Account {
  id           String        @id @default(cuid())
  firstName    String
  lastName     String
  middleName   String?       @default("N/A")
  email        String        @unique
  password     String
  role         Role          @default(encoder)
  status       AccountStatus @default(pending)
  
  // Relations
  createdPatients       Patient[] @relation("PatientCreator")
  updatedPatients       Patient[] @relation("PatientUpdater")
  createdServices       Service[] @relation("ServiceCreator")
  updatedServices       Service[] @relation("ServiceUpdater")
  medicalDocumentations MedicalDocumentation[]

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@map("accounts")
  @@index([email])
  @@index([role])
  @@index([status])
}

model Patient {
  id                  String    @id @default(cuid())
  firstName           String
  lastName            String
  middleName          String?   @default("N/A")
  birthDate           DateTime
  csdIdOrPwdId        String?
  mobileNumber        String?
  residentialAddress  String?
  isArchived          Boolean   @default(false)
  
  // Relations - can be created/updated by any role
  createdById         String
  updatedById         String
  creator             Account   @relation("PatientCreator", fields: [createdById], references: [id])
  updater             Account   @relation("PatientUpdater", fields: [updatedById], references: [id])
  medicalDocumentations MedicalDocumentation[]
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("patients")
  @@index([isArchived])
}

model Service {
  id              String          @id @default(cuid())
  name            String          @unique
  category        ServiceCategory
  price           Float
  isActivated     Boolean         @default(true)
  isAvailable     Boolean         @default(true)
  
  // Relations - Services can only be updated by admin
  createdById     String
  updatedById     String
  creator         Account         @relation("ServiceCreator", fields: [createdById], references: [id])
  updater         Account         @relation("ServiceUpdater", fields: [updatedById], references: [id])
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@map("services")
  @@index([category])
  @@index([isActivated])
  @@index([name])
}

model MedicalDocumentation {
  id           String   @id @default(cuid())
  patientId    String
  createdById  String
  
  subjective   String?
  objective    String?
  assessment   String?
  prescription String?
  
  status       DocumentationStatus @default(draft)
  
  patient      Patient @relation(fields: [patientId], references: [id])
  creator      Account @relation(fields: [createdById], references: [id])

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("medical_documentations")
  @@index([patientId])
  @@index([createdById])
  @@index([status])
}

// ---------------- DOCUMENTATION NOTES ----------------
/*
- Medical documentation should not be updated after creation for audit trail.
  (ENFORCE in app layer or DB triggers â€” Prisma does not natively support immutability)

- At least one field (subjective, objective, assessment, or prescription) must be filled.
  (ENFORCE in app layer with validation OR via a Postgres CHECK constraint)

- Patient records are never deleted, only archived (isArchived flag).

- Accounts start as pending and must be activated before use.

- Services have unique names, can be activated/deactivated, and tied to categories for analytics.
*/
